name: Build Manuscript

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.4.552 # 使用具体版本

      - name: Install MikTeX
        run: |
          curl -L -O https://miktex.org/download/ctan/systems/win32/miktex/setup/unx/miktex-portable-linux-x86_64.tar.lzma          
          mkdir -p ~/miktex-portable
          tar --lzma -xf miktex-portable-linux-x86_64.tar.lzma -C ~/miktex-portable
          
          # 初始化MikTeX
          ~/miktex-portable/miktex/bin/x64/initexmf --set-config-value [MPM]AutoInstall=1
          ~/miktex-portable/miktex/bin/x64/initexmf --update-fndb
      
      - name: Configure MikTeX package repository
        run: |
          # 使用国内镜像加速
          initexmf --set-repository=https://mirrors.tuna.tsinghua.edu.cn/CTAN/systems/win32/miktex/tm/packages/
          initexmf --update-fndb
      
      - name: Install required LaTeX packages
        run: |
          # 安装基础LaTeX包
          mpm --install=adjustbox
          mpm --install=caption
          mpm --install=enumitem
          mpm --install=fancyhdr
          mpm --install=float
          mpm --install=geometry
          mpm --install=graphicx
          mpm --install=hyperref
          mpm --install=lineno
          mpm --install=lipsum
          mpm --install=listings
          mpm --install=makecell
          mpm --install=multirow
          mpm --install=tabularx
          mpm --install=titlesec
          mpm --install=upquote
          mpm --install=xcolor
          
          # 中文支持包
          mpm --install=xeCJK
          mpm --install=fontspec
          mpm --install=ctex

      - name: Verify MikTeX installation
        run: |
            验证 MikTeX 是否正常工作
            pdflatex --version
            xelatex --version # 验证 XeLaTeX（中文排版必需）

      - name: Render Manuscript (PDF, HTML, DOCX)
        run: quarto render

      # (可选) 部署 HTML 到 GitHub Pages
      - name: Deploy HTML to Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ # 假设 HTML 输出在根目录
          publish_branch: gh-pages
          force_orphan: true