name: Build Manuscript

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    container: ghcr.io/quarto-dev/quarto:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

    #   - name: Setup Quarto
    #     uses: quarto-dev/quarto-actions/setup@v2
    #     with:
    #       version: 1.4.552 # ä½¿ç”¨å…·ä½“ç‰ˆæœ¬

    #     # ä½¿ç”¨é¢„è£… Quarto å’Œ LaTeX çš„ç¯å¢ƒ
    # âœ… 1. å®‰è£… TinyTeX
      - name: Install TinyTeX with Strict Verification
        run: |
            # å®šä¹‰å˜é‡
            TINYTEX_ROOT="$HOME/.quarto/tinytex"
            TINYTEX_BIN="$TINYTEX_ROOT/bin/x86_64-linux"
            EXPECTED_FILE="$TINYTEX_BIN/pdflatex"  # å…³é”®å¯æ‰§è¡Œæ–‡ä»¶

            # æ¸…ç†å¯èƒ½çš„æ®‹ç•™ï¼ˆå¯é€‰ï¼‰
            # rm -rf "$TINYTEX_ROOT"

            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i to install TinyTeX..."

            # 1. å°è¯•å®‰è£…
            if quarto install tinytex; then
                echo "âœ… quarto install tinytex command succeeded."
            else
                echo "âŒ quarto install tinytex failed with exit code $?."
                continue
            fi

            # 2. ä¸¥æ ¼éªŒè¯ï¼šæ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
            if [ -f "$EXPECTED_FILE" ]; then
                echo "âœ… TinyTeX installation verified! pdflatex found at $EXPECTED_FILE"
                # å®‰è£…æˆåŠŸï¼Œè·³å‡ºå¾ªç¯
                break
            else
                echo "âŒ Installation seems incomplete. $EXPECTED_FILE not found."
                echo "Contents of $TINYTEX_ROOT (if exists):"
                ls -la "$TINYTEX_ROOT" || echo "Directory not found."
                echo "Contents of $TINYTEX_ROOT/bin (if exists):"
                ls -la "$TINYTEX_ROOT/bin/" || true

                # æ¸…ç†ä¸å®Œæ•´çš„å®‰è£…ï¼Œä¸ºä¸‹æ¬¡é‡è¯•åšå‡†å¤‡
                if [ -d "$TINYTEX_ROOT" ]; then
                echo "Cleaning up incomplete installation..."
                rm -rf "$TINYTEX_ROOT"
                fi

                # å¦‚æœä¸æ˜¯æœ€åä¸€æ¬¡é‡è¯•ï¼Œç­‰å¾…åé‡è¯•
                if [ $i -lt $MAX_RETRIES ]; then
                echo "Retrying in 45 seconds..."
                sleep 45
                else
                echo "âŒ Failed to install TinyTeX after $MAX_RETRIES attempts."
                exit 1
                fi
            fi
            done

            # 3. åªæœ‰å®‰è£…å¹¶éªŒè¯æˆåŠŸåï¼Œæ‰æ·»åŠ åˆ° PATH
            if [ -f "$EXPECTED_FILE" ]; then
            echo "Adding $TINYTEX_BIN to PATH"
            echo "$TINYTEX_BIN" >> $GITHUB_PATH
            else
            echo "âŒ Critical: TinyTeX verification failed at the end."
            exit 1
            fi
        shell: bash

    # âœ… ç°åœ¨éªŒè¯
      - name: Verify LaTeX tools
        run: |
            which pdflatex || { echo "pdflatex not found"; exit 1; }
            which xelatex  || { echo "xelatex not found"; exit 1; }
            which lualatex || { echo "lualatex not found"; exit 1; }
            pdflatex --version
            xelatex --version
        shell: bash

    #     # å®‰è£…è½»é‡çº§ MiKTeX
    #   - name: Install MiKTeX
    #     run: |
    #       # 1. ä¸‹è½½å¹¶å®‰è£… MiKTeX GPG å¯†é’¥
          
    #       wget https://miktex.org/download/key -O- | sudo gpg --dearmor --yes --output /usr/share/keyrings/miktex.gpg
    #       # 2. æ·»åŠ  MiKTeX è½¯ä»¶æº
    #       echo "deb [arch=amd64 signed-by=/usr/share/keyrings/miktex.gpg] https://miktex.org/download/ubuntu focal universe" | sudo tee /etc/apt/sources.list.d/miktex.list          # 3. æ›´æ–°è½¯ä»¶åŒ…åˆ—è¡¨
    #       sudo apt update
    #       # 4. å®‰è£… MiKTeX
    #       sudo apt-get install -y miktex

    #   # âš™ï¸ é…ç½® MiKTeX (å…³é”®æ­¥éª¤)
    #   - name: Configure MiKTeX
    #     run: |
    #       # è®¾ç½®ä¸ºå…è®¸è‡ªåŠ¨å®‰è£…å®åŒ… (æ ¸å¿ƒï¼)
    #       initexmf --set-config-value "[MPM]AllowInstaller=1"
    #       # æˆ–è€…ä½¿ç”¨æ›´ç›´æ¥çš„å‘½ä»¤è¡Œæ–¹å¼
    #       mpm --admin --enable-installer

    #       # (å¯é€‰) è®¾ç½®åŒ…æ•°æ®åº“ä½ç½® (é¿å…æƒé™é—®é¢˜)
    #       # initexmf --set-config-value "[Paths]CommonInstall=R:/miktex"

    #       # (å¯é€‰) è®¾ç½®ä¸ºç”¨æˆ·æ¨¡å¼å®‰è£… (é€šå¸¸ CI ç¯å¢ƒæ¨è)
    #       # initexmf --user-install=yes

    #       # (å¯é€‰) æ›´æ–° MiKTeX æ•°æ®åº“
    #       initexmf --update-fndb

    #   # ğŸ§ª æµ‹è¯• MiKTeX (å¯é€‰ï¼Œç”¨äºè°ƒè¯•)
    #   - name: Test MiKTeX
    #     run: |
    #       miktex --version
    #       # å°è¯•ç¼–è¯‘ä¸€ä¸ªæç®€çš„ LaTeX æ–‡ä»¶æ¥è§¦å‘é¦–æ¬¡å®åŒ…å®‰è£…
    #       echo '\documentclass{article}\begin{document}Hello\end{document}' > test.tex
    #       pdflatex test.tex || echo "Initial compilation may fail, that's OK."
    #       rm test.tex


      - name: Render Manuscript (PDF, HTML, DOCX)
        run: quarto render

      # (å¯é€‰) éƒ¨ç½² HTML åˆ° GitHub Pages
      - name: Deploy HTML to Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ # å‡è®¾ HTML è¾“å‡ºåœ¨æ ¹ç›®å½•
          publish_branch: gh-pages
          force_orphan: true