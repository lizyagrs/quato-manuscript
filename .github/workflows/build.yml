name: Build Manuscript

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest
    # container: ghcr.io/quarto-dev/quarto:latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Setup Quarto
        uses: quarto-dev/quarto-actions/setup@v2
        with:
          version: 1.4.552 # 使用具体版本

    #     # 使用预装 Quarto 和 LaTeX 的环境
    # ✅ 1. 安装 TinyTeX
      - name: Install TinyTeX with Retry
        run: |
            MAX_RETRIES=3
            for i in $(seq 1 $MAX_RETRIES); do
            echo "Attempt $i to install TinyTeX..."
            if quarto install tinytex; then
                echo "✅ TinyTeX installed successfully."
                break
            else
                echo "❌ Attempt $i failed."
                if [ $i -eq $MAX_RETRIES ]; then
                echo "❌ Failed to install TinyTeX after $MAX_RETRIES attempts."
                exit 1
                fi
                echo "Retrying in 30 seconds..."
                sleep 30
            fi
            done

            # 再次确认目录
            if [ ! -d "$HOME/.quarto/tinytex/bin/x86_64-linux" ]; then
            echo "❌ ERROR: TinyTeX installation incomplete!"
            ls -la "$HOME/.quarto/tinytex/" || true
            exit 1
            fi

            # 添加到 PATH
            echo "$HOME/.quarto/tinytex/bin/x86_64-linux" >> $GITHUB_PATH
        shell: bash

    # ✅ 现在验证
      - name: Verify LaTeX tools
        run: |
            which pdflatex || { echo "pdflatex not found"; exit 1; }
            which xelatex  || { echo "xelatex not found"; exit 1; }
            which lualatex || { echo "lualatex not found"; exit 1; }
            pdflatex --version
            xelatex --version
        shell: bash

    #     # 安装轻量级 MiKTeX
    #   - name: Install MiKTeX
    #     run: |
    #       # 1. 下载并安装 MiKTeX GPG 密钥
          
    #       wget https://miktex.org/download/key -O- | sudo gpg --dearmor --yes --output /usr/share/keyrings/miktex.gpg
    #       # 2. 添加 MiKTeX 软件源
    #       echo "deb [arch=amd64 signed-by=/usr/share/keyrings/miktex.gpg] https://miktex.org/download/ubuntu focal universe" | sudo tee /etc/apt/sources.list.d/miktex.list          # 3. 更新软件包列表
    #       sudo apt update
    #       # 4. 安装 MiKTeX
    #       sudo apt-get install -y miktex

    #   # ⚙️ 配置 MiKTeX (关键步骤)
    #   - name: Configure MiKTeX
    #     run: |
    #       # 设置为允许自动安装宏包 (核心！)
    #       initexmf --set-config-value "[MPM]AllowInstaller=1"
    #       # 或者使用更直接的命令行方式
    #       mpm --admin --enable-installer

    #       # (可选) 设置包数据库位置 (避免权限问题)
    #       # initexmf --set-config-value "[Paths]CommonInstall=R:/miktex"

    #       # (可选) 设置为用户模式安装 (通常 CI 环境推荐)
    #       # initexmf --user-install=yes

    #       # (可选) 更新 MiKTeX 数据库
    #       initexmf --update-fndb

    #   # 🧪 测试 MiKTeX (可选，用于调试)
    #   - name: Test MiKTeX
    #     run: |
    #       miktex --version
    #       # 尝试编译一个极简的 LaTeX 文件来触发首次宏包安装
    #       echo '\documentclass{article}\begin{document}Hello\end{document}' > test.tex
    #       pdflatex test.tex || echo "Initial compilation may fail, that's OK."
    #       rm test.tex


      - name: Render Manuscript (PDF, HTML, DOCX)
        run: quarto render

      # (可选) 部署 HTML 到 GitHub Pages
      - name: Deploy HTML to Pages
        if: success()
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./ # 假设 HTML 输出在根目录
          publish_branch: gh-pages
          force_orphan: true